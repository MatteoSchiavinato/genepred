# Nextflow tricks

## resuming a crashed run

Nextflow has a built-in system to resume runs that have crashed under any circumstance. Due to its architecture, it has a wide variety of files that are used as semaphores for the pipeline to proceed or not beyond a certain process. To resume a pipeline that has crashed, all you need to do is re-run it with the addition of the `-resume` option.

```
nextflow \
run \
main.nf \
-resume \
[rest of the command] ...
```

The nextflow interpreter will look inside the directory where you placed the `main.nf` and `nextflow.config` scripts, searching for a directory called `.nextflow.log`. Try to `ls -la` inside your scripts directory and you'll see it.

## setting a specific work directory

The `work` directory is where Nextflow puts all its intermediate files and its temp / output files. This directory is unique for a certain run. If you're using multiple runs (e.g. multiple samples) it's better if you create a new `work` directory for each one of them. This way, it will be easier to control their content in the future.

To set a specific work directory, you can add this flag after `main.nf` (and after `-resume`, if you're using it), in your command:

```
nextflow \
run \
main.nf \
-resume \
-work-dir <path/to/work/dir> \
[rest of the command] ...
```

## getting statistics on your run

Nextflow can generate many statistics that are useful to quantify how fast and how demanding a certain pipeline run is. For example, you can quantify easily how many GB of RAM and how many CPU hours it has used up. This is useful for Core Facility work but also for benchmarking of different tools / options.

There are three main types of tracking files: a **report**, a **timeline** and a **dag** (direct acyclic graph). The report contains the most important metrics about CPU and RAM usage, plus a pipeline progress plot and a few barplots that quantify the amount of resources that each step of the pipeline used up. The timeline shows the pipeline proceeding in terms of hours / days. The dag creates a plot that shows how the workflow proceeds. To include all three, you can add these flags in your command:

```
nextflow \
run \
main.nf \
-resume \
-work-dir <path/to/work/dir> \
-with-report <path/to/report.html> \
-with-timeline <path/to/timeline.html> \
-with-dag <path/to/dag.png> \
```

## deleting previous runs

Nextflow has many options: try running `nextflow -h`. Among these, you'll see `nextflow log`. This command (if run in the directory where you have `main.nf`) logs all the nextflow runs that you have already run in this folder. The output contains several lines that look like this:

```
2021-05-28 12:55:25	1h 59m 2s     	deadly_gautier    	ERR   	0c75929cd1 	58cdb614-4773-4519-bcd0-3e37e1bdded5	nextflow main.nf ...
```

These lines contain lots of information on the run: date, duration, a mnemonic name (e.g. deadly_gautier), how it ended (e.g. ERR means it crashed), its associated codes and finally the full command (`nextflow main.nf ... `).

Once a process is completed, the output files are copied from the `work` directory into your specified output directory (`--output_directory`). This means that for every file generated by the pipeline there are two copies: one in `work`, and one in the output directory.

Once you're finished with a pipeline and you know you won't run it again, it's good practice to remove its temporary files so that you limit file number usage and disk usage. Be aware that removing files in the `work` directory cancels also the pipeline history, so if you run it again with `-resume`, it will still start from the beginning.

To clean files inside `work`, you should use `nextflow clean`. If you want to remove the files associated to a specific run, simply execute `nextflow clean deadly_gautier` and all files related to this run will be removed by the `work` directory (not the copied output files: those will stay). If you run `nextflow clean -h` you'll see many options related to clean. For example with `-before deadly_gautier` you will delete all runs before deadly_gautier. I guess you can figure out how `-after` and `-but` work. A specific case is how to delete everything: just run `nextflow clean -f` without specifying any run.
